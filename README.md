# AWS S3 Block SSE-C Encryption

A Python toolkit for scanning AWS S3 buckets and blocking Server-Side Encryption with Customer-Provided Keys (SSE-C).

AWS recently [announced](https://aws.amazon.com/blogs/storage/advanced-notice-amazon-s3-to-disable-the-use-of-sse-c-encryption-by-default-for-all-new-buckets-and-select-existing-buckets-in-april-2026/) plans to disable SSE-C encryption by default for all new buckets starting April 2016. At that time, SSE-C will also be disabled for existing that do not contain SSE-C-encrypted data. This toolkit helps block SSE-C on your S3 buckets in advance of that change.

:warning: Note that this toolkit does not check for existing SSE-C encrypted objects. It only modifies bucket-level encryption settings to block future use of SSE-C.

## Overview

This project provides two primary utilities:

1. **`scan_buckets.py`** - Scans S3 buckets and generates an inventory with metadata including:
   - Bucket name, region, and creation date
   - Current tags
   - SSE-C blocking status
   - Target designation for remediation

2. **`block_sse_c.py`** - Applies SSE-C blocking to target buckets by:
   - Reading the inventory generated by `scan_buckets.py`
   - Preserving existing encryption configurations
   - Adding SSE-C to the blocked encryption types list
   - Generating detailed results reports

## Why Block SSE-C?

SSE-C (Server-Side Encryption with Customer-Provided Keys) allows users to provide their own encryption keys for S3 objects. While this offers flexibility, it can create security and compliance challenges:

- **Ransomware Attack Vector**: Malicious actors or compromised credentials can use SSE-C to encrypt S3 objects with attacker-controlled keys, effectively holding data for ransom. Since the encryption key is provided by the client and not stored by AWS, legitimate users cannot decrypt the data without the attacker's key. This makes SSE-C a potential weapon for ransomware attacks targeting cloud storage.
- **Key Management Risk**: Organizations must manage and track encryption keys manually, increasing the risk of key loss or unauthorized access
- **Compliance Issues**: May not meet certain regulatory requirements that mandate AWS-managed keys
- **Operational Complexity**: Requires custom key handling in all client applications
- **Audit Trail**: Harder to track and audit key usage compared to AWS-managed solutions
- **No Recovery Options**: Unlike AWS-managed encryption, there's no way to recover SSE-C encrypted data if the customer-provided key is lost or withheld

Blocking SSE-C enforces the use of AWS-managed encryption (SSE-S3 or SSE-KMS), improving security posture, simplifying key management, and protecting against ransomware attacks that exploit client-provided encryption keys.

## Prerequisites

- Python 3.10 or higher
- AWS CLI configured with appropriate credentials
- IAM permissions for S3 operations (see [Required IAM Permissions](#required-iam-permissions))

## Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd aws-s3-block-sse-c
```

2. Install dependencies:
```bash
pip install -r requirements.txt
```

3. Configure AWS credentials:
```bash
aws configure
```

Or use environment variables:
```bash
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_DEFAULT_REGION=us-east-1
```

## Required IAM Permissions

The AWS credentials used must have the following IAM permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListAllMyBuckets",
        "s3:GetBucketLocation",
        "s3:GetBucketTagging",
        "s3:GetEncryptionConfiguration",
        "s3:PutEncryptionConfiguration"
      ],
      "Resource": "*"
    }
  ]
}
```

**Note**: `PutEncryptionConfiguration` is only required for `block_sse_c.py`. `scan_buckets.py` requires only read permissions.

## Usage

### Step 1: Scan S3 Buckets

Generate an inventory of all S3 buckets with their current encryption status:

```bash
python scan_buckets.py
```

**Options:**
- `-o, --output <filename>`: Output JSON filename (default: `buckets.json`)
- `-r, --region <region>`: Filter buckets by specific AWS region (e.g., `us-east-1`)

**Examples:**

Scan all buckets across all regions:
```bash
python scan_buckets.py -o my-buckets.json
```

Scan only buckets in us-east-1:
```bash
python scan_buckets.py -r us-east-1 -o us-east-1-buckets.json
```

**Output Format:**

The scan generates a JSON file with the following structure:

```json
{
  "target_regions": null,
  "buckets": [
    {
      "name": "my-bucket-name",
      "region": "us-east-1",
      "creation_date": "2023-01-15T10:30:00+00:00",
      "sse_c_blocked": false,
      "tags": {
        "Environment": "Production",
        "Owner": "DevOps"
      },
      "target": true
    }
  ],
  "summary": {
    "total_buckets_in_target_regions": 42,
    "total_buckets_scanned": 42
  }
}
```

### Step 2: Review and Mark Targets

Before blocking SSE-C, review the generated JSON file and update the `target` field:

- Set `"target": true` for buckets where you want to block SSE-C
- Set `"target": false` for buckets that should be excluded

```json
{
  "name": "my-important-bucket",
  "target": true,  // ← This bucket will be processed
  ...
}
```

```json
{
  "name": "legacy-bucket-with-special-needs",
  "target": false,  // ← This bucket will be skipped
  ...
}
```

### Step 3: Block SSE-C on Target Buckets

Apply SSE-C blocking to buckets marked as targets:

```bash
python block_sse_c.py
```

**Options:**
- `-i, --input <filename>`: Input JSON filename (default: `buckets.json`)
- `-o, --output <filename>`: Output results JSON filename (default: `block_sse_c_results.json`)

**Examples:**

Block SSE-C using default files:
```bash
python block_sse_c.py
```

Specify custom input and output files:
```bash
python block_sse_c.py -i my-buckets.json -o my-results.json
```

**Output:**

The script provides real-time console output:

```
Found 42 buckets in file ...
================================================================================

Processing bucket: my-bucket-name (region: us-east-1)
  → Fetching existing encryption configuration...
  → Found 1 existing encryption rule(s)
     Rule 1: Algorithm=aws:kms, BucketKey=True, Blocked=[]
  → Adding SSE-C to blocked encryption types...
     Rule 1: Added SSE-C to blocked types
  → Applying updated encryption configuration...
  → Configuration applied successfully
  ✓ Successfully blocked SSE-C

...

================================================================================
Summary:
  Total target buckets: 42
  Successfully blocked: 40
  Skipped (already blocked): 2
  Failed: 0

Detailed results written to: block_sse_c_results.json
```

**Results File Format:**

```json
[
  {
    "bucket": "my-bucket-name",
    "region": "us-east-1",
    "action": "blocked",
    "status": "success"
  },
  {
    "bucket": "already-secure-bucket",
    "region": "us-west-2",
    "action": "skipped",
    "reason": "already_blocked"
  },
  {
    "bucket": "failed-bucket",
    "region": "eu-west-1",
    "action": "failed",
    "error_code": "AccessDenied",
    "error": "User is not authorized to perform: s3:PutEncryptionConfiguration"
  }
]
```

## Complete Workflow Example

Here's a complete end-to-end workflow:

```bash
# 1. Scan all S3 buckets in us-east-1
python scan_buckets.py -r us-east-1 -o production-buckets.json

# 2. Review the output file and edit target flags as needed
# Edit production-buckets.json and set "target": true/false for each bucket

# 3. Apply SSE-C blocking to target buckets
python block_sse_c.py -i production-buckets.json -o production-results.json

# 4. Review the results
cat production-results.json
```

## How It Works

### Encryption Configuration Preservation

The `block_sse_c.py` script is designed to be non-destructive:

1. **Fetches existing configuration**: Retrieves the current bucket encryption settings
2. **Creates default if needed**: If no encryption is configured, creates a default SSE-S3 rule
3. **Preserves existing rules**: Maintains all existing encryption algorithms (SSE-S3, SSE-KMS)
4. **Adds SSE-C to blocked list**: Updates or creates the `BlockedEncryptionTypes` list
5. **Applies updated configuration**: Saves the modified configuration back to the bucket

**Before:**
```json
{
  "Rules": [
    {
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "aws:kms",
        "KMSMasterKeyID": "arn:aws:kms:..."
      },
      "BucketKeyEnabled": true
    }
  ]
}
```

**After:**
```json
{
  "Rules": [
    {
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "aws:kms",
        "KMSMasterKeyID": "arn:aws:kms:..."
      },
      "BucketKeyEnabled": true,
      "BlockedEncryptionTypes": {
        "EncryptionType": ["SSE-C"]
      }
    }
  ]
}
```

## Error Handling

Both scripts include comprehensive error handling:

### Common Errors

| Error | Description | Solution |
|-------|-------------|----------|
| `AccessDenied` | Insufficient IAM permissions | Add required S3 permissions to your IAM user/role |
| `NoSuchBucket` | Bucket no longer exists | Re-run scan to update inventory |
| `ServerSideEncryptionConfigurationNotFoundError` | No encryption config | Script creates default SSE-S3 configuration |
| `FileNotFoundError` | Input file not found | Verify the input filename and path |
| `JSONDecodeError` | Invalid JSON format | Check JSON syntax in input file |

### Script Exit Codes

- `0`: Success
- `1`: Error occurred (check console output for details)

## Best Practices

1. **Test in Non-Production First**: Always test on development/staging buckets before production
2. **Backup Configurations**: Document existing encryption configurations before making changes
3. **Review Target Flags**: Carefully review and set target flags to avoid unintended changes
4. **Use Region Filtering**: For large environments, process one region at a time
5. **Check Results**: Always review the results JSON file after blocking
6. **Incremental Rollout**: Process buckets in batches rather than all at once
7. **Monitor CloudTrail**: Track S3 configuration changes via AWS CloudTrail logs

## Troubleshooting

### No buckets found in scan

**Problem**: `scan_buckets.py` returns 0 buckets

**Solutions**:
- Verify AWS credentials are configured correctly
- Check IAM permissions include `s3:ListAllMyBuckets`
- Ensure region filter (if used) matches your bucket locations

### Permission denied when blocking SSE-C

**Problem**: `block_sse_c.py` fails with AccessDenied

**Solutions**:
- Add `s3:PutEncryptionConfiguration` permission to your IAM policy
- Check bucket policies for restrictions
- Verify you have permissions for the specific bucket regions

### Script hangs during execution

**Problem**: Script appears to freeze

**Solutions**:
- Check network connectivity to AWS
- Verify AWS credentials haven't expired
- For large environments, use region filtering to reduce scope

## Security Considerations

- **Least Privilege**: Use IAM policies that grant only necessary permissions
- **Credential Management**: Never commit AWS credentials to version control
- **Audit Logging**: Enable CloudTrail logging for S3 configuration changes
- **Change Management**: Follow your organization's change management procedures
- **Rollback Plan**: Document how to remove SSE-C blocks if needed

## Rollback

To remove SSE-C blocking from a bucket:

```python
import boto3

s3_client = boto3.client('s3')
bucket_name = 'your-bucket-name'

# Get current configuration
response = s3_client.get_bucket_encryption(Bucket=bucket_name)
rules = response['ServerSideEncryptionConfiguration']['Rules']

# Remove SSE-C from blocked types
for rule in rules:
    if 'BlockedEncryptionTypes' in rule:
        encryption_types = rule['BlockedEncryptionTypes'].get('EncryptionType', [])
        if 'SSE-C' in encryption_types:
            encryption_types.remove('SSE-C')
            rule['BlockedEncryptionTypes']['EncryptionType'] = encryption_types

# Apply updated configuration
s3_client.put_bucket_encryption(
    Bucket=bucket_name,
    ServerSideEncryptionConfiguration={'Rules': rules}
)
```

## Contributing

Contributions are welcome! Please follow these guidelines:

1. Fork the repository
2. Create a feature branch
3. Make your changes with clear commit messages
4. Test thoroughly
5. Submit a pull request

## License

At this time, no license is specified.

## Support

Members of the Cornell community can seek help through the [CIT Help Desk](https://it.cornell.edu/support).

## Related AWS Documentation

- [Advanced notice: Amazon S3 to disable the use of SSE-C encryption by default for all new buckets and select existing buckets in April 2026](https://aws.amazon.com/blogs/storage/advanced-notice-amazon-s3-to-disable-the-use-of-sse-c-encryption-by-default-for-all-new-buckets-and-select-existing-buckets-in-april-2026/)
- [S3 Server-Side Encryption](https://docs.aws.amazon.com/AmazonS3/latest/userguide/serv-side-encryption.html)
- [SSE-C Specification](https://docs.aws.amazon.com/AmazonS3/latest/userguide/ServerSideEncryptionCustomerKeys.html)
- [S3 Encryption Configuration API](https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutBucketEncryption.html)
- [S3 Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html)
